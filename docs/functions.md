# 関数・イベント仕様書（VBA）

## 1. 全体構成

このファイルでは、Input シートおよびブック全体で使用する  
VBA のイベント・関数・サブルーチンの役割と仕様を定義する。

主な構成要素は以下の通り：

- ThisWorkbook モジュール  
  - Workbook_Open  

- Input シートモジュール  
  - Worksheet_Change  
  - IsProductCode  
  - FillProduct  
  - FillHalfProduct  
  - WriteHalfProduct  
  - SetB5Appearance  
  - SetDropdowns  

---

## 2. ThisWorkbook モジュール

### 2.1 Workbook_Open

**役割**  
- ブックを開いたときに、Input シートの作業日（B2）に今日の日付を設定する。

**仕様**  
- 対象シート：Input  
- 対象セル：B2  
- 設定値：Date（システム日付）

**擬似コード**

- Sheets("Input").Range("B2") に Date を代入する。

---

## 3. Input シートモジュール

### 3.1 Worksheet_Change

**トリガー**  
- Input シートのセルが変更されたとき  
- 対象セル：B4（作業コード）のみ

**役割**  
1. 作業コード（B4）の変更を検知する  
2. 作業区分（B3）を自動判定する  
3. B5〜B9 を製品／半製品に応じて自動入力する  
4. B5・B9 のロック／色など UI を制御する  
5. 大分類・中分類のプルダウンを切り替える  

**処理の流れ**

1. Target が B4 以外なら何もしない  
2. B4 が空欄なら何もしない  
3. Application.EnableEvents = False にして再帰呼び出しを防止  
4. B4 の値を code として取得  
5. code が「製品コード」かどうかを IsProductCode で判定  
6. 判定結果に応じて B3 に「製品」または「半製品」を設定  
7. SetB5Appearance を呼び出し、B5・B9 の見た目とロック状態を更新  
8. B3 の値に応じて FillProduct または FillHalfProduct を呼び出す  
9. SetDropdowns を呼び出し、B6・B7 のプルダウンを更新  
10. Application.EnableEvents = True に戻す  

---

### 3.2 IsProductCode

**役割**  
- 渡された文字列が「製品コード」かどうかを判定する。

**仕様**  
- 引数：code（String）  
- 戻り値：Boolean  
- 判定条件：  
  - 長さが 4 文字  
  - ハイフンを含まない  

---

### 3.3 FillProduct

**役割**  
- 製品コードに対して、T商品名テーブルから情報を取得し、Input シートに反映する。

**仕様**

- 引数：code（String）  
- 処理内容：  
  1. T商品名シートの ListObject「T商品名」を取得  
  2. テーブルの「コード」列と code が一致する行を検索  
  3. 見つからなければメッセージを表示して終了  
  4. 見つかった場合、以下のように Input シートへ書き込む  
     - B5：空欄  
     - B6：中分類  
     - B7：小分類  
     - B8：空欄  
     - B9：商品名  

---

### 3.4 FillHalfProduct

**役割**  
- 半製品コードに対して、ＴＤＳテーブルから情報を取得し、Input シートに反映する。

**仕様**

- 引数：code（String）  
- 処理内容：  

1. ＴＤＳシートの ListObject「ＴＤＳ」を取得  

2. 通常パターンの検索  
   - テーブルの「記号」列と code が一致する行を検索  
   - 見つかった場合：  
     - 工程名：行の「工程」列の値  
     - WriteHalfProduct を呼び出し、工程名を渡して終了  

3. イレギュラーパターンの判定  
   - code の長さが 9 文字  
   - 2文字目がハイフン  
   - 条件を満たす場合：  
     - 先頭1文字を工程コード engCode とする  
     - 3文字目以降を baseCode とする  

4. 工程コードから工程名を決定  
   - f → 成型  
   - c → 検品  
   - h → 包装糖  
   - k → カット・検品  
   - 上記以外 → 不明  

5. baseCode と「記号」列が一致する行を検索  
   - 見つかった場合：  
     - WriteHalfProduct を呼び出し、工程名を渡して終了  

6. どちらのパターンでも見つからなかった場合  
   - メッセージを表示して終了  

---

### 3.5 WriteHalfProduct

**役割**  
- 半製品の情報を Input シートに書き込む共通処理。

**仕様**

- 引数：  
  - r：ListRow（ＴＤＳテーブルの対象行）  
  - engName：工程名（String）  

- 処理内容：  
  1. r から以下の値を取得  
     - 形状  
     - 色  
     - 種類  

  2. 工程が「プリント」の場合の例外処理  
     - 中分類（B7）：文字列「プリント」  
     - 詳分類（B8）：色  

  3. 通常の場合  
     - 中分類（B7）：色  
     - 詳分類（B8）：空欄  

  4. Input シートへの書き込み  
     - B5：工程名  
     - B6：形状  
     - B7：中分類  
     - B8：詳分類  
     - B9：種類  

---

### 3.6 SetB5Appearance

**役割**  
- B3（作業区分）に応じて、B5（半製品工程）と B9（名称）の見た目とロック状態を制御する。

**仕様**

- B5  
  - 製品の場合  
    - 値：空欄  
    - 背景色：薄いグレー  
    - 文字色：薄いグレー  
    - Locked = True  
  - 半製品の場合  
    - 背景色：白  
    - 文字色：黒  
    - Locked = True（自動入力のみで手入力不可）  

- B9  
  - 常に Locked = True  
  - 背景色はやや薄いグレーまたは白  
  - 自動入力のみ  

---

### 3.7 SetDropdowns

**役割**  
- B3（作業区分）に応じて、B6（大分類）・B7（中分類）のプルダウン内容を切り替える。

**仕様**

- 製品の場合  
  - B6：T商品名テーブルの「中分類」列をリストとして設定  
  - B7：T商品名テーブルの「小分類」列をリストとして設定  

- 半製品の場合  
  - B6：ＴＤＳテーブルの「形状」列をリストとして設定  
  - B7：ＴＤＳテーブルの「色」列をリストとして設定  

- B8  
  - データ検証は削除（プルダウンなし）  

---

## 4. 今後追加が想定される関数

- 製品／半製品で背景色を変えるための UI 制御関数  
- 入力ガイドを表示するためのヘルプ関数  
- 作業コードの候補を提示する補完関数  
- DB 登録処理（別モジュール）との連携関数
