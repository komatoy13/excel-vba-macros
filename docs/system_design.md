# Input システム設計書

## 1. 目的

このシステムは、作業コードをキーとして「製品／半製品」を自動判定し、  
対応するマスタ（T商品名／ＴＤＳ）から必要な情報を取得して、  
Input シートの B2〜B9 を一貫したルールで自動入力することを目的とする。

現場の入力作業を最小化し、  
・迷わせない  
・触っていい場所／ダメな場所が明確  
・マスタ変更に強い  
という設計思想を最優先とする。

---

## 2. Input シートの役割と構造

### 2.1 役割

- 作業単位の入力フォーム
- 作業コードから製品／半製品を自動判定
- マスタから名称・分類・工程を自動反映
- 現場が触るのは「本当に必要なセルだけ」に限定する

### 2.2 主なセル

- B2：作業日  
  - ブック起動時に今日の日付を自動入力  
  - スピンボタンで ±1 日変更可能  

- B3：作業区分  
  - 「製品」または「半製品」  
  - 作業コード（B4）から自動判定  
  - ユーザー入力不可（ロック）  

- B4：作業コード  
  - 製品／半製品の判定キー  
  - 入力トリガー  

- B5：半製品工程  
  - 半製品時のみ自動入力  
  - 製品時は空欄  
  - 常に入力不可（ロック）  

- B6：大分類  
  - 製品：T商品名テーブルの「中分類」  
  - 半製品：ＴＤＳテーブルの「形状」  
  - プルダウン（製品／半製品で動的切替）  

- B7：中分類  
  - 製品：T商品名テーブルの「小分類」  
  - 半製品：ＴＤＳテーブルの「色」  
  - プリント時は「プリント」  
  - プルダウン（製品／半製品で動的切替）  

- B8：詳分類  
  - 基本空欄  
  - プリント時のみ「色」が入る  
  - プルダウンなし  

- B9：名称  
  - 製品：T商品名テーブルの「商品名」  
  - 半製品：ＴＤＳテーブルの「種類」  
  - 常に入力不可（ロック）  

---

## 3. 作業コード判定ロジック

### 3.1 製品コード

- 条件  
  - 4文字  
  - ハイフン無し  

- 例  
  - AB12  
  - XY99  

- 判定  
  - B3 = 「製品」  
  - 抽出元：T商品名テーブル  
  - B5 は空欄（工程は使わない）

### 3.2 半製品コード

以下のいずれかに該当するものはすべて「半製品」と判定する。

1. ＴＤＳテーブルの「記号」列と完全一致するコード  
   - 例：p-nkfc-uc  
   - 例：p-hibs-pi  
   - 例：a-b  

2. イレギュラー形式（9文字：1字-xxxx-yy）  
   - 先頭1文字：工程コード（f/c/h/k）  
   - 3文字目以降：ＴＤＳテーブルの「記号」列と一致  
   - 例：f-irka-ao  
   - 例：c-irka-ao  

---

## 4. 製品の自動入力仕様（T商品名テーブル）

作業コードが「製品」と判定された場合、  
T商品名テーブルから以下のように値を取得し、Input シートへ反映する。

- B5（半製品工程）  
  - 空欄  
  - 製品では工程を扱わない  

- B6（大分類）  
  - T商品名テーブルの「中分類」  

- B7（中分類）  
  - T商品名テーブルの「小分類」  

- B8（詳分類）  
  - 空欄  

- B9（名称）  
  - T商品名テーブルの「商品名」  

---

## 5. 半製品の自動入力仕様（ＴＤＳテーブル）

作業コードが「半製品」と判定された場合、  
ＴＤＳテーブルから以下のように値を取得し、Input シートへ反映する。

- B5（半製品工程）  
  - 通常パターン：ＴＤＳテーブルの「工程」  
  - イレギュラーパターン：工程コード（f/c/h/k）から決定した工程名  

- B6（大分類）  
  - ＴＤＳテーブルの「形状」  

- B7（中分類）  
  - 通常：ＴＤＳテーブルの「色」  
  - 工程が「プリント」の場合：文字列「プリント」  

- B8（詳分類）  
  - 通常：空欄  
  - 工程が「プリント」の場合：ＴＤＳテーブルの「色」  

- B9（名称）  
  - ＴＤＳテーブルの「種類」  

---

## 6. 工程の決定ロジック（半製品）

### 6.1 通常パターン

- 作業コードがＴＤＳテーブルの「記号」列と完全一致する場合  
- 工程はＴＤＳテーブルの「工程」列をそのまま使用する  

### 6.2 イレギュラーパターン（9文字形式）

- 作業コード形式：1字-xxxx-yy（合計9文字）  
- 先頭1文字が工程コード  
- 3文字目以降がＴＤＳテーブルの「記号」列と一致  

工程コードと工程名の対応は以下の通り：

- f → 成型  
- c → 検品  
- h → 包装糖  
- k → カット・検品  

---

## 7. UI 制御仕様

### 7.1 作業区分（B3）

- 作業コード入力時に自動判定  
- ユーザー入力不可（ロック）  
- 背景色は薄いグレー  

### 7.2 半製品工程（B5）

- 常に入力不可（ロック）  
- 製品時：空欄＋グレーアウト（背景グレー・文字色薄め）  
- 半製品時：白背景＋自動入力  

### 7.3 名称（B9）

- 常に入力不可（ロック）  
- 製品／半製品ともに自動入力のみ  

### 7.4 大分類・中分類（B6・B7）

- 製品／半製品でプルダウンの内容を切り替える  
- 製品時  
  - B6：T商品名テーブルの「中分類」  
  - B7：T商品名テーブルの「小分類」  
- 半製品時  
  - B6：ＴＤＳテーブルの「形状」  
  - B7：ＴＤＳテーブルの「色」  

### 7.5 詳分類（B8）

- プルダウンは設定しない  
- 通常は空欄  
- 工程が「プリント」の場合のみ、色を入れる  

### 7.6 作業日（B2）

- ブック起動時に今日の日付を自動入力  
- スピンボタンで ±1 日変更可能  

---

## 8. イベント構成

- ThisWorkbook  
  - Workbook_Open  
    - Input シートの B2 に今日の日付を設定  

- Input シートモジュール  
  - Worksheet_Change  
    - B4（作業コード）変更時に実行  
    - 作業区分の判定  
    - 製品／半製品の自動入力  
    - UI 制御（B3〜B9 の状態変更）  
  - FillProduct  
    - 製品コード用のマスタ参照ロジック  
  - FillHalfProduct  
    - 半製品コード用のマスタ参照ロジック  
  - WriteHalfProduct  
    - 半製品の共通書き込み処理  
  - SetB5Appearance  
    - B5・B9 のロック／色制御  
  - SetDropdowns  
    - B6・B7 のプルダウン切り替え  

---

## 9. 今後の拡張

- 製品／半製品で背景色を変える  
- 入力ガイドの表示  
- 作業コードのリアルタイム補完  
- DB 登録処理との統合  
- ログ・履歴管理との連携
